<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Emoji é€‚é…å¯ç¼–è¾‘å·¥å…·</title>
  <!-- Twemojiï¼ˆç”¨äºé¢„è§ˆä¸å¿«ç…§å¯¼å‡ºï¼›ç¦»çº¿å¯æ”¹ç”¨æœ¬åœ°æ–‡ä»¶ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/twemoji@14.0.2/dist/twemoji.min.js" crossorigin="anonymous"></script>
  <style>
    :root { --bg:#0f1115; --panel:#151924; --muted:#a7b0c0; --ring:#3b82f6; --text:#e6ebf5; --accent:#22c55e; }
    *{box-sizing:border-box}
    body{ margin:0; padding:16px; background:var(--bg); color:var(--text);
      font-family: ui-sans-serif,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",
                   "PingFang SC","Hiragino Sans GB","Noto Sans CJK SC","Microsoft YaHei",sans-serif; }
    h1{font-size:18px;margin:0 0 12px}
    .wrap{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .panel{ background:var(--panel); border:1px solid #22283a; border-radius:12px; padding:12px; box-shadow:0 4px 18px rgba(0,0,0,.22);}
    .toolbar{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px}
    button{ background:#1d2332; color:var(--text); border:1px solid #2a3248; border-radius:10px; padding:8px 12px; cursor:pointer; font-size:14px;}
    button:hover{border-color:var(--ring)}
    button.primary{background:#1e293b;border-color:var(--ring)}
    .editor,.preview{ min-height:62vh; max-height:75vh; overflow:auto; padding:12px; border-radius:10px; border:1px solid #26304a; outline:none; background:#0f1320;
      line-height:1.55; font-size:16px; white-space:pre-wrap;
      font-family: inherit,"Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji","Twemoji Mozilla","EmojiOne Color"; }
    .editor:focus{box-shadow:0 0 0 2px var(--ring) inset}
    .muted{color:var(--muted); font-size:12px}
    .hidden{display:none}
    .badge{padding:2px 8px;border-radius:999px;background:#13202b;color:#6de39b;font-size:12px}
    /* Twemoji å›¾ç‰‡åœ¨é¢„è§ˆä¸­çš„æ ·å¼ */
    .preview img.emoji{height:1em;width:1em;margin:0 .05em;vertical-align:-0.1em;}
    /* æ‰“å°ç”¨æ ·å¼ */
    @media print { body { background:#fff; } .wrap { display:block; } .panel{ box-shadow:none; } }
  </style>
  <!-- html2pdf.js for PDF export -->
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js" crossorigin="anonymous"></script>
</head>
<body>
  <h1>Emoji é€‚é…å¯ç¼–è¾‘å·¥å…· <span class="badge">å¯¼å‡ºï¼šHTML / HTML(å¿«ç…§) / MD / PDF</span></h1>
  <div class="wrap">
    <section class="panel">
      <div class="toolbar">
        <button id="btn-fix" class="primary">ä¿®å¤æ—§å¼ Keycapï¼ˆ1âƒ£â†’1ï¸âƒ£ï¼‰</button>
        <button id="btn-list">æ®µé¦–æ•°å­—â†’Keycapï¼ˆ1./1ã€/1-ï¼‰</button>
        <button id="btn-copy">å¤åˆ¶æ–‡æœ¬</button>
        <button id="btn-clear">æ¸…ç©º</button>
      </div>
      <div id="editor" class="editor" contenteditable="true" spellcheck="false" dir="auto">
2025 Zhangjiajie Travel Guide Is Here!!!||
The 9 Must-See Spots in Zhangjiajieâ—â—Read Before You Goâ—
ğŸ“Must-see attractions:
1ï¸âƒ£ Zhangjiajie National Forest Park
2ï¸âƒ£ Tianmen Mountain National Forest Park
3ï¸âƒ£ Wulingyuan Scenic Area
4ï¸âƒ£ Baofeng Lake
5ï¸âƒ£ Huanglong Cave
6ï¸âƒ£ Zhangjiajie Grand Canyon Glass Bridge
7ï¸âƒ£ Furong Town
8ï¸âƒ£ Phoenix Ancient Town (Fenghuang)
9ï¸âƒ£ Tianmen Cave
      </div>
      <div class="muted">æç¤ºï¼šå…ˆç‚¹â€œä¿®å¤æ—§å¼ Keycapâ€ï¼Œå¿…è¦æ—¶å†æŠŠæ®µé¦–æ•°å­—è½¬æ¢ä¸º 1ï¸âƒ£2ï¸âƒ£3ï¸âƒ£ã€‚</div>
    </section>

    <section class="panel">
      <div class="toolbar">
        <button id="btn-toggle">å¼€å¯ Twemoji é¢„è§ˆ</button>
        <button id="btn-exp-html">å¯¼å‡ºï¼šå¯ç¼–è¾‘ HTML</button>
        <button id="btn-exp-html-tw">å¯¼å‡ºï¼šå±•ç¤ºä¸€è‡´ HTMLï¼ˆTwemoji å¿«ç…§ï¼‰</button>
        <button id="btn-exp-md">å¯¼å‡ºï¼šMarkdown (.md)</button>
        <button id="btn-print">ä¿å­˜ä¸º PDF</button>
      </div>
      <div id="preview" class="preview hidden" aria-live="polite"></div>
      <div id="previewHint" class="muted">æœªå¼€å¯é¢„è§ˆï¼ˆä¸ºé¿å…æŠŠæ–‡å­—æ›¿æ¢æˆå›¾ç‰‡ï¼Œç¼–è¾‘åŒºä¿æŒåŸç”Ÿ emojiï¼‰ã€‚</div>
    </section>
  </div>

  <script>
    const editor   = document.getElementById('editor');
    const preview  = document.getElementById('preview');
    const btnFix   = document.getElementById('btn-fix');
    const btnList  = document.getElementById('btn-list');
    const btnCopy  = document.getElementById('btn-copy');
    const btnClear = document.getElementById('btn-clear');
    const btnToggle= document.getElementById('btn-toggle');
    const btnExpHTML = document.getElementById('btn-exp-html');
    const btnExpHTMLTw = document.getElementById('btn-exp-html-tw');
    const btnExpMD  = document.getElementById('btn-exp-md');
    const btnPrint  = document.getElementById('btn-print');
    const hint     = document.getElementById('previewHint');

    // å·¥å…·å‡½æ•°
    function fixLegacyKeycaps(str){ return str.replace(/([0-9])\u20E3/g, '$1\uFE0F\u20E3'); }
    function listDigitsToKeycap(str){ return str.replace(/(^|\n)([1-9])(?:[.\-ã€\)]?\s)/g, (_, p, d) => `${p}${d}\uFE0F\u20E3 `); }
    function escapeHTML(s){ return s.replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
    function download(filename, content, mime='text/plain'){
      const blob = new Blob([content], {type: mime + ';charset=utf-8'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
    }

    // é¢„è§ˆï¼ˆTwemojiï¼‰
    let previewOn = false;
    function updatePreview(){
      if(!previewOn) return;
      // ç”¨ innerText é˜²æ­¢ç”¨æˆ·ç²˜è´´çš„ HTML å¹²æ‰°
      preview.textContent = editor.innerText;
      if(window.twemoji){
        twemoji.parse(preview, {base:'https://cdn.jsdelivr.net/npm/twemoji@14.0.2/assets/', folder:'svg', ext:'.svg'});
      }
    }

    // äº‹ä»¶ï¼šæ¸…æ´— & è½¬æ¢
    btnFix.addEventListener('click', () => { editor.innerText = fixLegacyKeycaps(editor.innerText); updatePreview(); });
    btnList.addEventListener('click', () => { editor.innerText = listDigitsToKeycap(editor.innerText); updatePreview(); });
    btnCopy.addEventListener('click', async () => {
      try { await navigator.clipboard.writeText(editor.innerText);
        btnCopy.textContent='å·²å¤åˆ¶ âœ…'; setTimeout(()=>btnCopy.textContent='å¤åˆ¶æ–‡æœ¬',1200);
      } catch(e){ alert('å¤åˆ¶å¤±è´¥ï¼š'+e); }
    });
    btnClear.addEventListener('click', () => { editor.innerText = ''; updatePreview(); });

    btnToggle.addEventListener('click', () => {
      previewOn = !previewOn;
      preview.classList.toggle('hidden', !previewOn);
      hint.classList.toggle('hidden',  previewOn);
      btnToggle.textContent = previewOn ? 'å…³é—­ Twemoji é¢„è§ˆ' : 'å¼€å¯ Twemoji é¢„è§ˆ';
      updatePreview();
    });
    editor.addEventListener('input', updatePreview);

    // å¯¼å‡ºï¼šå¯ç¼–è¾‘ HTMLï¼ˆåŸç”Ÿ emojiï¼‰
    btnExpHTML.addEventListener('click', () => {
      const content = editor.innerText; // çº¯æ–‡æœ¬ï¼Œä¿è¯å¹²å‡€
      const html = `<!doctype html>
<html lang="zh-CN"><head><meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Document (Editable, Native Emoji)</title>
<style>
  body{margin:24px;font-family: ui-sans-serif,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",
        "PingFang SC","Hiragino Sans GB","Noto Sans CJK SC","Microsoft YaHei",sans-serif;}
  .doc{white-space:pre-wrap;line-height:1.6;font-size:16px}
  .doc{font-family: inherit,"Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji","Twemoji Mozilla","EmojiOne Color";}
</style></head><body>
<div class="doc" contenteditable="true" dir="auto">${escapeHTML(content)}</div>
</body></html>`;
      download('document-editable.html', html, 'text/html');
    });

    // å¯¼å‡ºï¼šå±•ç¤ºä¸€è‡´ HTMLï¼ˆTwemoji å¿«ç…§ï¼Œemoji å·²è½¬ä¸º <img>ï¼‰
    btnExpHTMLTw.addEventListener('click', () => {
      // æ„å»ºå¿«ç…§å®¹å™¨
      const temp = document.createElement('div');
      temp.textContent = editor.innerText;
      if(window.twemoji){ twemoji.parse(temp, {base:'https://cdn.jsdelivr.net/npm/twemoji@14.0.2/assets/', folder:'svg', ext:'.svg'}); }
      const snapshot = temp.innerHTML;
      const html = `<!doctype html>
<html lang="zh-CN"><head><meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Document (Twemoji Snapshot)</title>
<style>
  body{margin:24px;font-family: ui-sans-serif,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",
        "PingFang SC","Hiragino Sans GB","Noto Sans CJK SC","Microsoft YaHei",sans-serif;}
  .doc{white-space:pre-wrap;line-height:1.6;font-size:16px}
  .doc img.emoji{height:1em;width:1em;margin:0 .05em;vertical-align:-0.1em;}
</style></head><body>
<div class="doc" dir="auto">${snapshot}</div>
<!-- æ³¨ï¼šæ­¤ç‰ˆæœ¬ä¸ºå±•ç¤ºä¸€è‡´çš„å¿«ç…§ï¼Œemoji ä¸º <img>ï¼›éœ€è¦è”ç½‘è®¿é—® jsDelivr çš„ Twemoji èµ„æºã€‚ -->
</body></html>`;
      download('document-twemoji.html', html, 'text/html');
    });

    // å¯¼å‡ºï¼šMarkdown
    btnExpMD.addEventListener('click', () => {
      const md = editor.innerText; // å·²æ˜¯ UTF-8 æ–‡æœ¬ + emoji
      download('document.md', md, 'text/markdown');
    });

    // ä¿å­˜ä¸º PDFï¼ˆTwemoji å¿«ç…§ -> ç›´æ¥ç”Ÿæˆå¹¶ä¸‹è½½ PDFï¼‰
    btnPrint.addEventListener('click', async () => {
      if(!window.html2pdf){
        alert('PDF ç»„ä»¶åŠ è½½å¤±è´¥ï¼Œè¯·è”ç½‘åé‡è¯•');
        return;
      }
      
      // æ˜¾ç¤ºåŠ è½½æç¤º
      btnPrint.textContent = 'ç”Ÿæˆä¸­...';
      btnPrint.disabled = true;
      
      try {
        // 1) åˆ›å»ºå®¹å™¨ç”¨äºPDFç”Ÿæˆ
        const container = document.createElement('div');
        container.className = 'pdf-container';
        
        // è®¾ç½®å®¹å™¨æ ·å¼ - ä½¿ç”¨å›ºå®šå®šä½å¹¶æš‚æ—¶å¯è§
        container.style.cssText = `
          position: fixed;
          left: -10000px;
          top: 0;
          width: 794px;
          background: #ffffff;
          color: #000000;
          padding: 40px;
          line-height: 1.8;
          font-size: 16px;
          white-space: pre-wrap;
          font-family: ui-sans-serif, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", 
                       "PingFang SC", "Hiragino Sans GB", "Noto Sans CJK SC", "Microsoft YaHei", sans-serif;
          visibility: visible;
          opacity: 1;
          z-index: 999999;
          box-sizing: border-box;
        `;
        
        // è®¾ç½®å†…å®¹
        container.textContent = editor.innerText;
        document.body.appendChild(container);
        
        // 2) è§£æemojiä¸ºå›¾ç‰‡
        if(window.twemoji){
          twemoji.parse(container, {
            base: 'https://cdn.jsdelivr.net/npm/twemoji@14.0.2/assets/',
            folder: '72x72', 
            ext: '.png',
            attributes: () => ({ 
              crossorigin: 'anonymous',
              style: 'height: 1.2em; width: 1.2em; margin: 0 0.05em; vertical-align: -0.2em;'
            })
          });
        }
        
        // 3) ç­‰å¾…æ‰€æœ‰å›¾ç‰‡åŠ è½½å®Œæˆ
        const imgs = container.querySelectorAll('img');
        if(imgs.length > 0) {
          await Promise.all(Array.from(imgs).map(img => {
            return new Promise((resolve) => {
              if(img.complete && img.naturalHeight !== 0) {
                resolve();
              } else {
                img.addEventListener('load', resolve, {once: true});
                img.addEventListener('error', resolve, {once: true});
                // è®¾ç½®è¶…æ—¶ï¼Œé¿å…æ— é™ç­‰å¾…
                setTimeout(resolve, 3000);
              }
            });
          }));
        }
        
        // 4) å°†å®¹å™¨ç§»åˆ°å¯è§åŒºåŸŸè¿›è¡Œæ•è·
        container.style.left = '0';
        container.style.top = '0';
        
        // ç­‰å¾…æµè§ˆå™¨æ¸²æŸ“
        await new Promise(resolve => requestAnimationFrame(() => {
          requestAnimationFrame(resolve);
        }));
        
        // 5) é…ç½®å¹¶ç”ŸæˆPDF
        const opt = {
          margin: [0.5, 0.5, 0.5, 0.5],  // ä¸Šå³ä¸‹å·¦è¾¹è·ï¼ˆè‹±å¯¸ï¼‰
          filename: 'emoji_document.pdf',
          image: { 
            type: 'jpeg', 
            quality: 0.95 
          },
          html2canvas: { 
            scale: 2,
            useCORS: true,
            backgroundColor: '#ffffff',
            logging: false,
            allowTaint: false,
            foreignObjectRendering: false,
            windowWidth: 850,  // è®¾ç½®çª—å£å®½åº¦ç¡®ä¿æ­£ç¡®æ¸²æŸ“
            windowHeight: 1200,
            scrollX: 0,
            scrollY: 0,
            x: 0,
            y: 0,
            width: 794,  // æ˜ç¡®æŒ‡å®šæ•è·å®½åº¦
            height: container.scrollHeight  // ä½¿ç”¨å®é™…é«˜åº¦
          },
          jsPDF: { 
            unit: 'in', 
            format: 'a4', 
            orientation: 'portrait',
            compress: true
          },
          pagebreak: { 
            mode: ['avoid-all', 'css', 'legacy'] 
          }
        };
        
        // ç”Ÿæˆå¹¶ä¸‹è½½PDF
        await html2pdf().from(container).set(opt).save();
        
        // æ¸…ç†
        container.remove();
        
      } catch(error) {
        console.error('PDFç”Ÿæˆå¤±è´¥:', error);
        alert('PDFç”Ÿæˆå¤±è´¥ï¼š' + error.message);
      } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        btnPrint.textContent = 'ä¿å­˜ä¸º PDF';
        btnPrint.disabled = false;
      }
    });

    // åˆå§‹è½»åº¦ä¿®å¤
    editor.innerText = fixLegacyKeycaps(editor.innerText);
  </script>
</body>
</html>